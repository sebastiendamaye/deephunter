"""
MalwareBazaar connector
"""

from connectors.utils import get_connector_conf, is_valid_md5, is_valid_sha1, is_valid_sha256
import logging
import requests
from django.conf import settings

# Get an instance of a logger
logger = logging.getLogger(__name__)

# Set to True for debugging purposes
DEBUG = False

# Import settings from Django settings
PROXY = settings.PROXY

# Retrieve connector settings from the database
API_KEY = get_connector_conf('malwarebazaar', 'API_KEY')

def check_hash(hash):
    """
    Check if a hash exists in MalwareBazaar.
    
    :param hash: The hash to check.
    :return: Array with hash results if the hash exists, None otherwise.
    """
    if is_valid_md5(hash) or is_valid_sha1(hash) or is_valid_sha256(hash):

        headers = {
            'Auth-Key': API_KEY,
            'accept': 'application/json'
        }

        data = {
            'query':'get_info',
            'hash':hash
            }
        response = requests.post(
            'https://mb-api.abuse.ch/api/v1/',
            data=data,
            headers=headers,
            proxies=PROXY
            )
        if response.status_code == 200 and 'data' in response.json():
            return response.json()['data'][0]
        else:
            logger.error(f"Failed to check hash {hash}: {response.status_code}")
            return None
