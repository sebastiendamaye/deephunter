"""
MalwareBazaar connector
"""

from connectors.utils import get_connector_conf, is_valid_md5, is_valid_sha1, is_valid_sha256
import requests
from django.conf import settings
from notifications.utils import add_error_notification

_globals_initialized = False
def init_globals():
    global DEBUG, PROXY, API_KEY
    global _globals_initialized
    if not _globals_initialized:
        DEBUG = False
        PROXY = settings.PROXY
        API_KEY = get_connector_conf('malwarebazaar', 'API_KEY')
        _globals_initialized = True

def check_hash(hash):
    """
    Check if a hash exists in MalwareBazaar.
    
    :param hash: The hash to check.
    :return: Array with hash results if the hash exists, None otherwise.
    """
    init_globals()
    if is_valid_md5(hash) or is_valid_sha1(hash) or is_valid_sha256(hash):

        headers = {
            'Auth-Key': API_KEY,
            'accept': 'application/json'
        }

        data = {
            'query':'get_info',
            'hash':hash
            }
        response = requests.post(
            'https://mb-api.abuse.ch/api/v1/',
            data=data,
            headers=headers,
            proxies=PROXY
            )
        if response.status_code == 200 and 'data' in response.json():
            return response.json()['data'][0]
        else:
            add_error_notification(f"Malware Bazaar connector: Failed to check hash {hash}: {response.status_code}")
            return None
